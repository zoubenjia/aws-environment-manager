<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AWS Environment Manager</title>
    <style>
        body {
            width: 400px;
            min-height: 500px;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: system-ui, sans-serif;
            color: white;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .btn-add { background: #28a745; color: white; }
        .btn-view { background: #007bff; color: white; }
        .btn-reset { background: #ffc107; color: #212529; }
        .btn-clear { background: #dc3545; color: white; }
        
        .env-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .env-item {
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .env-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(4px);
        }
        
        .env-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .env-desc {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .status {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸš€ AWS Environment Manager</h2>
        <p>ç›´æ¥è§£å†³æ–¹æ¡ˆ</p>
    </div>
    
    <div class="status" id="status">
        çŠ¶æ€ï¼šå‡†å¤‡å°±ç»ª
    </div>
    
    <button class="btn btn-add" id="directAddBtn">
        â• ç›´æ¥æ·»åŠ ç¯å¢ƒ
    </button>
    
    <button class="btn btn-view" id="directViewBtn">
        ğŸ‘ï¸ æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒ
    </button>
    
    <button class="btn btn-reset" id="directResetBtn">
        ğŸ”„ é‡ç½®ä¸ºé»˜è®¤
    </button>
    
    <button class="btn btn-clear" id="directClearBtn">
        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®
    </button>
    
    <div class="env-list" id="envList">
        <!-- ç¯å¢ƒåˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
    
    <script>
        console.log('ğŸš€ ç›´æ¥è§£å†³æ–¹æ¡ˆè„šæœ¬å¼€å§‹æ‰§è¡Œ');
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(msg) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = 'çŠ¶æ€ï¼š' + msg;
                console.log('çŠ¶æ€ï¼š' + msg);
            }
        }
        
        // ç›´æ¥æ·»åŠ ç¯å¢ƒ
        async function directAddEnvironment() {
            console.log('ğŸ¯ ç›´æ¥æ·»åŠ ç¯å¢ƒå¼€å§‹');
            updateStatus('å¼€å§‹æ·»åŠ ç¯å¢ƒ...');
            
            try {
                // è·å–ç”¨æˆ·è¾“å…¥
                const name = prompt('è¯·è¾“å…¥ç¯å¢ƒåç§°:', 'æ–°ç¯å¢ƒ ' + new Date().toLocaleTimeString());
                if (!name || name.trim() === '') {
                    updateStatus('ç”¨æˆ·å–æ¶ˆæ·»åŠ ');
                    return;
                }
                
                const description = prompt('è¯·è¾“å…¥ç¯å¢ƒæè¿°:', 'è‡ªå®šä¹‰ç¯å¢ƒ');
                if (description === null) {
                    updateStatus('ç”¨æˆ·å–æ¶ˆæ·»åŠ ');
                    return;
                }
                
                // åˆ›å»ºç¯å¢ƒå¯¹è±¡
                const newEnv = {
                    id: 'direct_' + Date.now(),
                    name: name.trim(),
                    icon: 'ğŸ†•',
                    color: '#28a745',
                    description: description.trim() || 'è‡ªå®šä¹‰ç¯å¢ƒ',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess',
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console',
                    regions: ['us-east-1'],
                    createdAt: new Date().toISOString()
                };
                
                console.log('åˆ›å»ºçš„ç¯å¢ƒå¯¹è±¡:', newEnv);
                updateStatus('ä¿å­˜ç¯å¢ƒæ•°æ®...');
                
                // è·å–ç°æœ‰ç¯å¢ƒ
                const result = await browser.storage.local.get(['aws_environments']);
                let environments = result.aws_environments || [];
                console.log('ç°æœ‰ç¯å¢ƒæ•°é‡:', environments.length);
                
                // æ·»åŠ æ–°ç¯å¢ƒ
                environments.push(newEnv);
                console.log('æ·»åŠ åç¯å¢ƒæ•°é‡:', environments.length);
                
                // ä¿å­˜åˆ°å­˜å‚¨
                await browser.storage.local.set({
                    'aws_environments': environments,
                    'last_update': Date.now(),
                    'direct_add_count': (result.direct_add_count || 0) + 1
                });
                
                console.log('âœ… ç¯å¢ƒä¿å­˜æˆåŠŸ');
                
                // éªŒè¯ä¿å­˜
                const verification = await browser.storage.local.get(['aws_environments']);
                console.log('éªŒè¯ä¿å­˜ç»“æœ:', verification.aws_environments?.length);
                
                if (verification.aws_environments && verification.aws_environments.length === environments.length) {
                    updateStatus('ç¯å¢ƒæ·»åŠ æˆåŠŸï¼');
                    alert('âœ… ç¯å¢ƒæ·»åŠ æˆåŠŸï¼\n\n' + 
                          'åç§°: ' + newEnv.name + '\n' +
                          'ID: ' + newEnv.id + '\n' +
                          'æ€»ç¯å¢ƒæ•°: ' + environments.length);
                    
                    // åˆ·æ–°ç¯å¢ƒåˆ—è¡¨
                    await loadEnvironmentList();
                } else {
                    throw new Error('ä¿å­˜éªŒè¯å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ æ·»åŠ ç¯å¢ƒå¤±è´¥:', error);
                updateStatus('æ·»åŠ å¤±è´¥: ' + error.message);
                alert('âŒ æ·»åŠ ç¯å¢ƒå¤±è´¥:\n' + error.message);
            }
        }
        
        // æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒ
        async function directViewEnvironments() {
            console.log('ğŸ‘ï¸ æŸ¥çœ‹æ‰€æœ‰ç¯å¢ƒ');
            updateStatus('åŠ è½½ç¯å¢ƒæ•°æ®...');
            
            try {
                const result = await browser.storage.local.get(null);
                console.log('æ‰€æœ‰å­˜å‚¨æ•°æ®:', result);
                
                let msg = 'å­˜å‚¨æ•°æ®è¯¦æƒ…:\n\n';
                
                if (result.aws_environments) {
                    msg += 'ç¯å¢ƒæ•°é‡: ' + result.aws_environments.length + '\n\n';
                    result.aws_environments.forEach((env, index) => {
                        msg += (index + 1) + '. ' + env.name + '\n';
                        msg += '   ID: ' + env.id + '\n';
                        msg += '   æè¿°: ' + env.description + '\n';
                        msg += '   åˆ›å»º: ' + (env.createdAt || 'æœªçŸ¥') + '\n\n';
                    });
                } else {
                    msg += 'æ²¡æœ‰æ‰¾åˆ°ç¯å¢ƒæ•°æ®\n\n';
                }
                
                msg += 'å…¶ä»–æ•°æ®:\n';
                Object.keys(result).forEach(key => {
                    if (key !== 'aws_environments') {
                        msg += key + ': ' + typeof result[key] + '\n';
                    }
                });
                
                alert(msg);
                updateStatus('ç¯å¢ƒæ•°æ®æŸ¥çœ‹å®Œæˆ');
                
                // åŒæ—¶æ›´æ–°ç•Œé¢åˆ—è¡¨
                await loadEnvironmentList();
                
            } catch (error) {
                console.error('âŒ æŸ¥çœ‹ç¯å¢ƒå¤±è´¥:', error);
                updateStatus('æŸ¥çœ‹å¤±è´¥: ' + error.message);
                alert('âŒ æŸ¥çœ‹ç¯å¢ƒå¤±è´¥:\n' + error.message);
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒ
        async function directResetEnvironments() {
            console.log('ğŸ”„ é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒ');
            
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒå—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰ç¯å¢ƒï¼')) {
                updateStatus('ç”¨æˆ·å–æ¶ˆé‡ç½®');
                return;
            }
            
            updateStatus('é‡ç½®ç¯å¢ƒæ•°æ®...');
            
            const defaultEnvs = [
                {
                    id: 'production',
                    name: 'ç”Ÿäº§ç¯å¢ƒ',
                    icon: 'ğŸ”´',
                    color: '#dc3545',
                    description: 'ç”Ÿäº§ç¯å¢ƒ - è¯·è°¨æ…æ“ä½œ',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess',
                    regions: ['eu-west-2', 'us-east-1'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'development',
                    name: 'å¼€å‘ç¯å¢ƒ',
                    icon: 'ğŸŸ¢',
                    color: '#28a745',
                    description: 'å¼€å‘ç¯å¢ƒ - å®‰å…¨æµ‹è¯•',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess_dev',
                    regions: ['eu-central-1', 'us-west-2'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 'staging',
                    name: 'æµ‹è¯•ç¯å¢ƒ',
                    icon: 'ğŸ”µ',
                    color: '#007bff',
                    description: 'æµ‹è¯•ç¯å¢ƒ - é¢„å‘å¸ƒéªŒè¯',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess_staging',
                    regions: ['ap-southeast-1', 'ap-northeast-1'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console',
                    createdAt: new Date().toISOString()
                }
            ];
            
            try {
                await browser.storage.local.set({
                    'aws_environments': defaultEnvs,
                    'reset_timestamp': Date.now()
                });
                
                console.log('âœ… é‡ç½®æˆåŠŸ');
                updateStatus('é‡ç½®å®Œæˆ');
                alert('âœ… å·²é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒï¼\n\nå…± ' + defaultEnvs.length + ' ä¸ªç¯å¢ƒ');
                
                await loadEnvironmentList();
                
            } catch (error) {
                console.error('âŒ é‡ç½®å¤±è´¥:', error);
                updateStatus('é‡ç½®å¤±è´¥: ' + error.message);
                alert('âŒ é‡ç½®å¤±è´¥:\n' + error.message);
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function directClearAll() {
            console.log('ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®');
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰ç¯å¢ƒå’Œè®¾ç½®ï¼')) {
                updateStatus('ç”¨æˆ·å–æ¶ˆæ¸…ç©º');
                return;
            }
            
            updateStatus('æ¸…ç©ºæ•°æ®ä¸­...');
            
            try {
                await browser.storage.local.clear();
                console.log('âœ… æ¸…ç©ºæˆåŠŸ');
                updateStatus('æ•°æ®æ¸…ç©ºå®Œæˆ');
                alert('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
                
                // æ¸…ç©ºç•Œé¢åˆ—è¡¨
                const envList = document.getElementById('envList');
                if (envList) {
                    envList.innerHTML = '<div style="text-align: center; opacity: 0.7;">æ•°æ®å·²æ¸…ç©º</div>';
                }
                
            } catch (error) {
                console.error('âŒ æ¸…ç©ºå¤±è´¥:', error);
                updateStatus('æ¸…ç©ºå¤±è´¥: ' + error.message);
                alert('âŒ æ¸…ç©ºå¤±è´¥:\n' + error.message);
            }
        }
        
        // åŠ è½½ç¯å¢ƒåˆ—è¡¨åˆ°ç•Œé¢
        async function loadEnvironmentList() {
            console.log('ğŸ“‹ åŠ è½½ç¯å¢ƒåˆ—è¡¨åˆ°ç•Œé¢');
            
            try {
                const result = await browser.storage.local.get(['aws_environments']);
                const environments = result.aws_environments || [];
                
                const envList = document.getElementById('envList');
                if (!envList) return;
                
                if (environments.length === 0) {
                    envList.innerHTML = '<div style="text-align: center; opacity: 0.7;">æš‚æ— ç¯å¢ƒæ•°æ®</div>';
                    return;
                }
                
                envList.innerHTML = '';
                environments.forEach((env, index) => {
                    const envDiv = document.createElement('div');
                    envDiv.className = 'env-item';
                    envDiv.style.borderLeftColor = env.color || '#28a745';
                    
                    envDiv.innerHTML = `
                        <div class="env-name">${env.icon || 'ğŸ”¹'} ${env.name}</div>
                        <div class="env-desc">${env.description}</div>
                        <div style="font-size: 10px; opacity: 0.6; margin-top: 4px;">
                            ID: ${env.id} | åˆ›å»º: ${env.createdAt ? new Date(env.createdAt).toLocaleString() : 'æœªçŸ¥'}
                        </div>
                    `;
                    
                    // ç‚¹å‡»ç¯å¢ƒé¡¹æ‰“å¼€AWSæ§åˆ¶å°
                    envDiv.addEventListener('click', () => {
                        openAWSConsole(env);
                    });
                    
                    envList.appendChild(envDiv);
                });
                
                console.log('ç¯å¢ƒåˆ—è¡¨åŠ è½½å®Œæˆï¼Œå…±', environments.length, 'ä¸ªç¯å¢ƒ');
                
            } catch (error) {
                console.error('åŠ è½½ç¯å¢ƒåˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ‰“å¼€AWSæ§åˆ¶å°
        function openAWSConsole(env) {
            console.log('ğŸš€ æ‰“å¼€AWSæ§åˆ¶å°:', env.name);
            updateStatus('æ‰“å¼€æ§åˆ¶å°: ' + env.name);
            
            if (env.id === 'production') {
                if (!confirm(`âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°†æ‰“å¼€ç”Ÿäº§ç¯å¢ƒï¼\n\nç¯å¢ƒ: ${env.name}\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
                    updateStatus('ç”¨æˆ·å–æ¶ˆæ‰“å¼€ç”Ÿäº§ç¯å¢ƒ');
                    return;
                }
            }
            
            let url = 'https://console.aws.amazon.com/';
            
            if (env.ssoStartUrl && env.accountId && env.roleName) {
                const region = env.regions && env.regions.length > 0 ? env.regions[0] : 'us-east-1';
                const destination = `https://${region}.console.aws.amazon.com/console/home?region=${region}`;
                url = `${env.ssoStartUrl}?account_id=${env.accountId}&role_name=${env.roleName}&destination=${encodeURIComponent(destination)}`;
            }
            
            console.log('æ‰“å¼€URL:', url);
            
            try {
                browser.tabs.create({ url: url });
                updateStatus('æ§åˆ¶å°å·²æ‰“å¼€');
            } catch (error) {
                console.error('æ‰“å¼€æ§åˆ¶å°å¤±è´¥:', error);
                alert('âŒ æ‰“å¼€æ§åˆ¶å°å¤±è´¥: ' + error.message);
                updateStatus('æ‰“å¼€æ§åˆ¶å°å¤±è´¥');
            }
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            console.log('ğŸ”— ç»‘å®šäº‹ä»¶');
            
            const directAddBtn = document.getElementById('directAddBtn');
            if (directAddBtn) {
                directAddBtn.addEventListener('click', directAddEnvironment);
                console.log('âœ… ç›´æ¥æ·»åŠ æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            const directViewBtn = document.getElementById('directViewBtn');
            if (directViewBtn) {
                directViewBtn.addEventListener('click', directViewEnvironments);
                console.log('âœ… æŸ¥çœ‹ç¯å¢ƒæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            const directResetBtn = document.getElementById('directResetBtn');
            if (directResetBtn) {
                directResetBtn.addEventListener('click', directResetEnvironments);
                console.log('âœ… é‡ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            const directClearBtn = document.getElementById('directClearBtn');
            if (directClearBtn) {
                directClearBtn.addEventListener('click', directClearAll);
                console.log('âœ… æ¸…ç©ºæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            }
            
            updateStatus('æ‰€æœ‰äº‹ä»¶ç»‘å®šå®Œæˆ');
        }
        
        // åˆå§‹åŒ–
        function initialize() {
            console.log('ğŸš€ ç›´æ¥è§£å†³æ–¹æ¡ˆåˆå§‹åŒ–');
            updateStatus('åˆå§‹åŒ–ä¸­...');
            
            try {
                bindEvents();
                loadEnvironmentList();
                updateStatus('åˆå§‹åŒ–å®Œæˆ - å‡†å¤‡å°±ç»ª');
                console.log('âœ… ç›´æ¥è§£å†³æ–¹æ¡ˆåˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                updateStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // å¯åŠ¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
        
        console.log('ğŸš€ ç›´æ¥è§£å†³æ–¹æ¡ˆè„šæœ¬åŠ è½½å®Œæˆ');
    </script>
</body>
</html>
