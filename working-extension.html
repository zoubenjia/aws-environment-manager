<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Working Extension</title>
</head>
<body style="width: 350px; height: 400px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: system-ui;">
    <h3>ğŸš€ AWS Environment Manager</h3>
    
    <div id="status" style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 4px; margin: 10px 0; font-size: 12px;">
        çŠ¶æ€ï¼šåˆå§‹åŒ–ä¸­...
    </div>
    
    <button style="width: 100%; padding: 10px; margin: 8px 0; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;" 
            onmousedown="addEnvironmentDirect()">
        â• æ·»åŠ ç¯å¢ƒ
    </button>
    
    <button style="width: 100%; padding: 10px; margin: 8px 0; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" 
            onmousedown="viewEnvironments()">
        ğŸ‘ï¸ æŸ¥çœ‹ç¯å¢ƒ
    </button>
    
    <button style="width: 100%; padding: 10px; margin: 8px 0; background: #ffc107; color: #212529; border: none; border-radius: 4px; cursor: pointer;" 
            onmousedown="resetEnvironments()">
        ğŸ”„ é‡ç½®é»˜è®¤
    </button>
    
    <div id="envList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;">
        <!-- ç¯å¢ƒåˆ—è¡¨ -->
    </div>
    
    <script>
        console.log('Working extension script loading...');
        
        // ä½¿ç”¨onmousedownè€Œä¸æ˜¯onclickï¼Œæ›´å¯é 
        function updateStatus(msg) {
            const el = document.getElementById('status');
            if (el) {
                el.textContent = 'çŠ¶æ€ï¼š' + msg;
                console.log('Status:', msg);
            }
        }
        
        // æ·»åŠ ç¯å¢ƒ - ç›´æ¥æ–¹æ³•
        function addEnvironmentDirect() {
            console.log('Add environment called');
            updateStatus('æ·»åŠ ç¯å¢ƒä¸­...');
            
            try {
                const name = prompt('ç¯å¢ƒåç§°:', 'æ–°ç¯å¢ƒ');
                if (!name) {
                    updateStatus('ç”¨æˆ·å–æ¶ˆ');
                    return;
                }
                
                const env = {
                    id: 'env_' + Date.now(),
                    name: name,
                    icon: 'ğŸ†•',
                    color: '#28a745',
                    description: 'æ–°æ·»åŠ çš„ç¯å¢ƒ',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess',
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console',
                    regions: ['us-east-1']
                };
                
                console.log('Created env:', env);
                
                // ç›´æ¥ä½¿ç”¨browser.storage
                browser.storage.local.get(['aws_environments']).then(result => {
                    const envs = result.aws_environments || [];
                    envs.push(env);
                    return browser.storage.local.set({'aws_environments': envs});
                }).then(() => {
                    updateStatus('æ·»åŠ æˆåŠŸ');
                    alert('âœ… ç¯å¢ƒæ·»åŠ æˆåŠŸï¼\nåç§°ï¼š' + env.name);
                    loadEnvironmentList();
                }).catch(error => {
                    console.error('Save error:', error);
                    updateStatus('ä¿å­˜å¤±è´¥');
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
                });
                
            } catch (error) {
                console.error('Add error:', error);
                updateStatus('æ·»åŠ å¤±è´¥');
                alert('âŒ æ·»åŠ å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æŸ¥çœ‹ç¯å¢ƒ
        function viewEnvironments() {
            console.log('View environments called');
            updateStatus('æŸ¥çœ‹ç¯å¢ƒä¸­...');
            
            try {
                browser.storage.local.get(['aws_environments']).then(result => {
                    const envs = result.aws_environments || [];
                    let msg = 'ç¯å¢ƒåˆ—è¡¨ï¼š\n\n';
                    
                    if (envs.length === 0) {
                        msg += 'æš‚æ— ç¯å¢ƒ';
                    } else {
                        envs.forEach((env, index) => {
                            msg += (index + 1) + '. ' + env.name + '\n';
                            msg += '   ID: ' + env.id + '\n\n';
                        });
                    }
                    
                    alert(msg);
                    updateStatus('æŸ¥çœ‹å®Œæˆ');
                    loadEnvironmentList();
                }).catch(error => {
                    console.error('View error:', error);
                    updateStatus('æŸ¥çœ‹å¤±è´¥');
                    alert('âŒ æŸ¥çœ‹å¤±è´¥ï¼š' + error.message);
                });
            } catch (error) {
                console.error('View error:', error);
                updateStatus('æŸ¥çœ‹å¤±è´¥');
                alert('âŒ æŸ¥çœ‹å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // é‡ç½®ç¯å¢ƒ
        function resetEnvironments() {
            console.log('Reset environments called');
            
            if (!confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒå—ï¼Ÿ')) {
                updateStatus('ç”¨æˆ·å–æ¶ˆé‡ç½®');
                return;
            }
            
            updateStatus('é‡ç½®ä¸­...');
            
            const defaultEnvs = [
                {
                    id: 'production',
                    name: 'ç”Ÿäº§ç¯å¢ƒ',
                    icon: 'ğŸ”´',
                    color: '#dc3545',
                    description: 'ç”Ÿäº§ç¯å¢ƒ - è¯·è°¨æ…æ“ä½œ',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess',
                    regions: ['eu-west-2', 'us-east-1'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console'
                },
                {
                    id: 'development',
                    name: 'å¼€å‘ç¯å¢ƒ',
                    icon: 'ğŸŸ¢',
                    color: '#28a745',
                    description: 'å¼€å‘ç¯å¢ƒ - å®‰å…¨æµ‹è¯•',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess_dev',
                    regions: ['eu-central-1', 'us-west-2'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console'
                },
                {
                    id: 'staging',
                    name: 'æµ‹è¯•ç¯å¢ƒ',
                    icon: 'ğŸ”µ',
                    color: '#007bff',
                    description: 'æµ‹è¯•ç¯å¢ƒ - é¢„å‘å¸ƒéªŒè¯',
                    accountId: '487783143761',
                    roleName: 'PowerUserAccess_staging',
                    regions: ['ap-southeast-1', 'ap-northeast-1'],
                    ssoStartUrl: 'https://d-9067f2e3cc.awsapps.com/start/#/console'
                }
            ];
            
            try {
                browser.storage.local.set({'aws_environments': defaultEnvs}).then(() => {
                    updateStatus('é‡ç½®å®Œæˆ');
                    alert('âœ… å·²é‡ç½®ä¸ºé»˜è®¤ç¯å¢ƒï¼\nå…± ' + defaultEnvs.length + ' ä¸ªç¯å¢ƒ');
                    loadEnvironmentList();
                }).catch(error => {
                    console.error('Reset error:', error);
                    updateStatus('é‡ç½®å¤±è´¥');
                    alert('âŒ é‡ç½®å¤±è´¥ï¼š' + error.message);
                });
            } catch (error) {
                console.error('Reset error:', error);
                updateStatus('é‡ç½®å¤±è´¥');
                alert('âŒ é‡ç½®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // åŠ è½½ç¯å¢ƒåˆ—è¡¨åˆ°ç•Œé¢
        function loadEnvironmentList() {
            console.log('Loading environment list');
            
            try {
                browser.storage.local.get(['aws_environments']).then(result => {
                    const envs = result.aws_environments || [];
                    const container = document.getElementById('envList');
                    
                    if (!container) return;
                    
                    if (envs.length === 0) {
                        container.innerHTML = '<div style="text-align: center; opacity: 0.7; font-size: 12px;">æš‚æ— ç¯å¢ƒ</div>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    envs.forEach(env => {
                        const div = document.createElement('div');
                        div.style.cssText = 'background: rgba(255,255,255,0.1); margin: 4px 0; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px; border-left: 3px solid ' + (env.color || '#28a745');
                        div.innerHTML = env.icon + ' ' + env.name;
                        
                        div.onmousedown = function() {
                            openAWSConsole(env);
                        };
                        
                        container.appendChild(div);
                    });
                }).catch(error => {
                    console.error('Load list error:', error);
                });
            } catch (error) {
                console.error('Load list error:', error);
            }
        }
        
        // æ‰“å¼€AWSæ§åˆ¶å°
        function openAWSConsole(env) {
            console.log('Opening AWS console for:', env.name);
            updateStatus('æ‰“å¼€æ§åˆ¶å°: ' + env.name);
            
            if (env.id === 'production') {
                if (!confirm('âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°†æ‰“å¼€ç”Ÿäº§ç¯å¢ƒï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    updateStatus('ç”¨æˆ·å–æ¶ˆæ‰“å¼€ç”Ÿäº§ç¯å¢ƒ');
                    return;
                }
            }
            
            let url = 'https://console.aws.amazon.com/';
            
            if (env.ssoStartUrl && env.accountId && env.roleName) {
                const region = env.regions && env.regions.length > 0 ? env.regions[0] : 'us-east-1';
                const destination = `https://${region}.console.aws.amazon.com/console/home?region=${region}`;
                url = `${env.ssoStartUrl}?account_id=${env.accountId}&role_name=${env.roleName}&destination=${encodeURIComponent(destination)}`;
            }
            
            console.log('Opening URL:', url);
            
            try {
                browser.tabs.create({ url: url });
                updateStatus('æ§åˆ¶å°å·²æ‰“å¼€');
            } catch (error) {
                console.error('Open console error:', error);
                alert('âŒ æ‰“å¼€æ§åˆ¶å°å¤±è´¥ï¼š' + error.message);
                updateStatus('æ‰“å¼€å¤±è´¥');
            }
        }
        
        // åˆå§‹åŒ–
        function initialize() {
            console.log('Initializing extension');
            updateStatus('åˆå§‹åŒ–å®Œæˆ');
            loadEnvironmentList();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
        
        console.log('Working extension script loaded');
    </script>
</body>
</html>
