<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Environment Browser - é«˜çº§é…ç½®</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-description {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .environment-rule {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .environment-rule h4 {
            margin: 0 0 15px 0;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .rule-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .rule-conditions {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .condition-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .condition-item:last-child {
            margin-bottom: 0;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #4ecdc4;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .preview-section {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .url-preview {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            border: 1px solid #ddd;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #4ecdc4;
            color: #4ecdc4;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AWS Environment Browser é«˜çº§é…ç½®</h1>
        <p>è‡ªå®šä¹‰æ‚¨çš„AWSç¯å¢ƒè¯†åˆ«å’Œèµ·å§‹é¡µé…ç½®</p>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="basic">åŸºç¡€é…ç½®</div>
        <div class="tab" data-tab="environments">ç¯å¢ƒè§„åˆ™</div>
        <div class="tab" data-tab="preview">é¢„è§ˆæµ‹è¯•</div>
    </div>

    <!-- åŸºç¡€é…ç½® -->
    <div id="basic" class="tab-content active">
        <div class="section">
            <h2>ğŸ”§ åŸºç¡€è®¾ç½®</h2>
            
            <div class="form-group">
                <label class="form-label">AWS SSOèµ·å§‹URL</label>
                <input type="text" id="ssoStartUrl" class="form-input" 
                       placeholder="https://d-xxxxxxxxxx.awsapps.com/start/#/console"
                       value="https://d-9067f2e3cc.awsapps.com/start/#/console">
                <div class="form-description">æ‚¨çš„AWS SSOç™»å½•èµ·å§‹é¡µé¢URL</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">é»˜è®¤AWSè´¦æˆ·ID</label>
                <input type="text" id="defaultAccountId" class="form-input" 
                       placeholder="123456789012"
                       value="487783143761">
                <div class="form-description">æ‚¨çš„ä¸»è¦AWSè´¦æˆ·IDï¼ˆ12ä½æ•°å­—ï¼‰</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">URLæ¨¡æ¿</label>
                <input type="text" id="urlTemplate" class="form-input" 
                       value="{ssoUrl}?account_id={accountId}&role_name={roleName}&destination={destination}"
                       readonly>
                <div class="form-description">URLç”Ÿæˆæ¨¡æ¿ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œé€šå¸¸æ— éœ€ä¿®æ”¹ï¼‰</div>
            </div>
        </div>
    </div>

    <!-- ç¯å¢ƒè§„åˆ™ -->
    <div id="environments" class="tab-content">
        <div class="section">
            <h2>ğŸŒ ç¯å¢ƒè¯†åˆ«è§„åˆ™</h2>
            <p>æ ¹æ®è´¦æˆ·IDã€åŒºåŸŸã€è§’è‰²åç§°ç­‰æ¡ä»¶å®šä¹‰ä¸åŒçš„ç¯å¢ƒï¼Œå¹¶è®¾ç½®å¯¹åº”çš„é¢œè‰²æç¤ºã€‚</p>
            
            <div id="environmentRules">
                <!-- ç¯å¢ƒè§„åˆ™å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <button type="button" class="btn btn-primary" onclick="addEnvironmentRule()">
                â• æ·»åŠ ç¯å¢ƒè§„åˆ™
            </button>
        </div>
    </div>

    <!-- é¢„è§ˆæµ‹è¯• -->
    <div id="preview" class="tab-content">
        <div class="section">
            <h2>ğŸ” é…ç½®é¢„è§ˆå’Œæµ‹è¯•</h2>
            
            <div class="form-group">
                <label class="form-label">æµ‹è¯•å‚æ•°</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <select id="testEnvironment" class="form-input">
                        <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
                        <option value="development">å¼€å‘ç¯å¢ƒ</option>
                        <option value="staging">æµ‹è¯•ç¯å¢ƒ</option>
                    </select>
                    <select id="testRegion" class="form-input">
                        <option value="eu-west-2">eu-west-2 (ä¼¦æ•¦)</option>
                        <option value="eu-central-1">eu-central-1 (æ³•å…°å…‹ç¦)</option>
                        <option value="us-east-1">us-east-1 (åŒ—å¼—å‰å°¼äºš)</option>
                        <option value="us-west-2">us-west-2 (ä¿„å‹’å†ˆ)</option>
                    </select>
                    <button type="button" class="btn btn-secondary" onclick="generatePreviewUrl()">
                        ç”Ÿæˆé¢„è§ˆ
                    </button>
                </div>
            </div>
            
            <div class="preview-section">
                <h4>ç”Ÿæˆçš„URLé¢„è§ˆï¼š</h4>
                <div id="urlPreview" class="url-preview">
                    ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æŸ¥çœ‹URL
                </div>
                
                <div style="margin-top: 15px;">
                    <button type="button" class="btn btn-primary" onclick="testUrl()">
                        ğŸ§ª åœ¨æ–°æ ‡ç­¾é¡µä¸­æµ‹è¯•
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="copyUrl()">
                        ğŸ“‹ å¤åˆ¶URL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-success" id="saveAllSettings" onclick="saveAllSettings()">
            ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®
        </button>
        <button class="btn btn-secondary" onclick="resetToDefaults()">
            ğŸ”„ æ¢å¤é»˜è®¤è®¾ç½®
        </button>
    </div>

    <script>
        // é»˜è®¤ç¯å¢ƒè§„åˆ™
        let environmentRules = [
            {
                name: 'ç”Ÿäº§ç¯å¢ƒ',
                icon: 'ğŸ”´',
                color: '#ff6b6b',
                conditions: {
                    accountId: '487783143761',
                    rolePattern: 'PowerUserAccess_prod',
                    regions: ['eu-west-2', 'us-east-1']
                }
            },
            {
                name: 'å¼€å‘ç¯å¢ƒ',
                icon: 'ğŸŸ¢',
                color: '#4ecdc4',
                conditions: {
                    accountId: '487783143761',
                    rolePattern: 'PowerUserAccess_dev',
                    regions: ['eu-central-1', 'us-west-2']
                }
            },
            {
                name: 'æµ‹è¯•ç¯å¢ƒ',
                icon: 'ğŸ”µ',
                color: '#45b7d1',
                conditions: {
                    accountId: '487783143761',
                    rolePattern: 'PowerUserAccess_staging',
                    regions: ['ap-southeast-1', 'ap-northeast-1']
                }
            }
        ];

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            const targetTab = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°ç¯å¢ƒè§„åˆ™é¡µé¢ï¼Œç¡®ä¿æ¸²æŸ“ç¯å¢ƒè§„åˆ™
            if (tabName === 'environments') {
                renderEnvironmentRules();
            }
        }

        // æ¸²æŸ“ç¯å¢ƒè§„åˆ™
        function renderEnvironmentRules() {
            const container = document.getElementById('environmentRules');
            container.innerHTML = '';
            
            environmentRules.forEach((rule, index) => {
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'environment-rule';
                ruleDiv.innerHTML = `
                    <h4>
                        <span>${rule.icon} ${rule.name}</span>
                        <button type="button" class="btn btn-danger" onclick="removeEnvironmentRule(${index})">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </h4>
                    
                    <div class="rule-grid">
                        <div>
                            <label class="form-label">ç¯å¢ƒåç§°</label>
                            <input type="text" class="form-input" value="${rule.name}" 
                                   onchange="updateRule(${index}, 'name', this.value)">
                        </div>
                        
                        <div>
                            <label class="form-label">å›¾æ ‡</label>
                            <input type="text" class="form-input" value="${rule.icon}" 
                                   onchange="updateRule(${index}, 'icon', this.value)">
                        </div>
                        
                        <div>
                            <label class="form-label">é¢œè‰²</label>
                            <input type="color" class="color-picker" value="${rule.color}" 
                                   onchange="updateRule(${index}, 'color', this.value)">
                        </div>
                        
                        <div>
                            <label class="form-label">è§’è‰²åç§°æ¨¡å¼</label>
                            <input type="text" class="form-input" value="${rule.conditions.rolePattern}" 
                                   onchange="updateRuleCondition(${index}, 'rolePattern', this.value)">
                        </div>
                    </div>
                    
                    <div class="rule-conditions">
                        <label class="form-label">è¯†åˆ«æ¡ä»¶</label>
                        
                        <div class="condition-item">
                            <label>è´¦æˆ·ID:</label>
                            <input type="text" class="form-input" value="${rule.conditions.accountId}" 
                                   onchange="updateRuleCondition(${index}, 'accountId', this.value)">
                        </div>
                        
                        <div class="condition-item">
                            <label>é€‚ç”¨åŒºåŸŸ:</label>
                            <input type="text" class="form-input" value="${rule.conditions.regions.join(', ')}" 
                                   placeholder="eu-west-2, us-east-1"
                                   onchange="updateRuleCondition(${index}, 'regions', this.value.split(',').map(r => r.trim()))">
                        </div>
                    </div>
                `;
                
                container.appendChild(ruleDiv);
            });
        }

        // æ·»åŠ ç¯å¢ƒè§„åˆ™
        function addEnvironmentRule() {
            const newRule = {
                name: 'æ–°ç¯å¢ƒ',
                icon: 'âšª',
                color: '#6c757d',
                conditions: {
                    accountId: document.getElementById('defaultAccountId').value,
                    rolePattern: 'PowerUserAccess_new',
                    regions: ['us-east-1']
                }
            };
            
            environmentRules.push(newRule);
            renderEnvironmentRules();
        }

        // åˆ é™¤ç¯å¢ƒè§„åˆ™
        function removeEnvironmentRule(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç¯å¢ƒè§„åˆ™å—ï¼Ÿ')) {
                environmentRules.splice(index, 1);
                renderEnvironmentRules();
            }
        }

        // æ›´æ–°è§„åˆ™
        function updateRule(index, field, value) {
            environmentRules[index][field] = value;
        }

        // æ›´æ–°è§„åˆ™æ¡ä»¶
        function updateRuleCondition(index, field, value) {
            environmentRules[index].conditions[field] = value;
        }

        // ç”Ÿæˆé¢„è§ˆURL
        function generatePreviewUrl() {
            const ssoUrl = document.getElementById('ssoStartUrl').value;
            const accountId = document.getElementById('defaultAccountId').value;
            const environment = document.getElementById('testEnvironment').value;
            const region = document.getElementById('testRegion').value;
            
            // æ‰¾åˆ°å¯¹åº”çš„ç¯å¢ƒè§„åˆ™
            const rule = environmentRules.find(r => r.name.toLowerCase().includes(environment));
            const roleName = rule ? rule.conditions.rolePattern : 'PowerUserAccess_' + environment;
            
            const destinationUrl = `https://${region}.console.aws.amazon.com/console/home?region=${region}`;
            const encodedDestination = encodeURIComponent(destinationUrl);
            
            const finalUrl = `${ssoUrl}?account_id=${accountId}&role_name=${roleName}&destination=${encodedDestination}`;
            
            document.getElementById('urlPreview').textContent = finalUrl;
        }

        // æµ‹è¯•URL
        function testUrl() {
            const url = document.getElementById('urlPreview').textContent;
            if (url && url !== 'ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æŸ¥çœ‹URL') {
                window.open(url, '_blank');
            } else {
                alert('è¯·å…ˆç”Ÿæˆé¢„è§ˆURL');
            }
        }

        // å¤åˆ¶URL
        function copyUrl() {
            const url = document.getElementById('urlPreview').textContent;
            if (url && url !== 'ç‚¹å‡»"ç”Ÿæˆé¢„è§ˆ"æŸ¥çœ‹URL') {
                navigator.clipboard.writeText(url).then(() => {
                    alert('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } else {
                alert('è¯·å…ˆç”Ÿæˆé¢„è§ˆURL');
            }
        }

        // ä¿å­˜æ‰€æœ‰è®¾ç½®
        async function saveAllSettings() {
            const settings = {
                ssoStartUrl: document.getElementById('ssoStartUrl').value,
                defaultAccountId: document.getElementById('defaultAccountId').value,
                environmentRules: environmentRules
            };
            
            try {
                await browser.storage.local.set(settings);
                
                const button = document.getElementById('saveAllSettings');
                const originalText = button.textContent;
                button.textContent = 'âœ… å·²ä¿å­˜';
                button.style.background = '#28a745';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#28a745';
                }, 2000);
                
                alert('é…ç½®å·²ä¿å­˜ï¼è¯·é‡æ–°è½½å…¥æ‰©å±•ä»¥åº”ç”¨æ–°é…ç½®ã€‚');
                
            } catch (error) {
                console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯');
            }
        }

        // æ¢å¤é»˜è®¤è®¾ç½®
        function resetToDefaults() {
            if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è®¾ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é…ç½®ã€‚')) {
                document.getElementById('ssoStartUrl').value = 'https://d-9067f2e3cc.awsapps.com/start/#/console';
                document.getElementById('defaultAccountId').value = '487783143761';
                
                // é‡ç½®ç¯å¢ƒè§„åˆ™
                environmentRules = [
                    {
                        name: 'ç”Ÿäº§ç¯å¢ƒ',
                        icon: 'ğŸ”´',
                        color: '#ff6b6b',
                        conditions: {
                            accountId: '487783143761',
                            rolePattern: 'PowerUserAccess_prod',
                            regions: ['eu-west-2', 'us-east-1']
                        }
                    },
                    {
                        name: 'å¼€å‘ç¯å¢ƒ',
                        icon: 'ğŸŸ¢',
                        color: '#4ecdc4',
                        conditions: {
                            accountId: '487783143761',
                            rolePattern: 'PowerUserAccess_dev',
                            regions: ['eu-central-1', 'us-west-2']
                        }
                    },
                    {
                        name: 'æµ‹è¯•ç¯å¢ƒ',
                        icon: 'ğŸ”µ',
                        color: '#45b7d1',
                        conditions: {
                            accountId: '487783143761',
                            rolePattern: 'PowerUserAccess_staging',
                            regions: ['ap-southeast-1', 'ap-northeast-1']
                        }
                    }
                ];
                
                renderEnvironmentRules();
            }
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            try {
                const settings = await browser.storage.local.get([
                    'ssoStartUrl',
                    'defaultAccountId',
                    'environmentRules'
                ]);
                
                if (settings.ssoStartUrl) {
                    document.getElementById('ssoStartUrl').value = settings.ssoStartUrl;
                }
                
                if (settings.defaultAccountId) {
                    document.getElementById('defaultAccountId').value = settings.defaultAccountId;
                }
                
                if (settings.environmentRules) {
                    environmentRules = settings.environmentRules;
                }
                
                renderEnvironmentRules();
                
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç»‘å®šæ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // åŠ è½½è®¾ç½®å’Œæ¸²æŸ“ç¯å¢ƒè§„åˆ™
            loadSettings();
            renderEnvironmentRules();
        });
    </script>
</body>
</html>
